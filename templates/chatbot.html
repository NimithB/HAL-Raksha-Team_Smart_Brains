<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap');
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Inter", serif;
        }
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(#EEEEFF, #C8C7FF);
        }
        .chatbot-popup {
            position: relative;
            width: 420px;
            background: #fff;
            overflow: hidden;
            border-radius: 15px;
            box-shadow: 0 0 128px 0 rgba(0, 0, 0, 0.1), 0 32px 64px -48px rgba(0, 0, 0, 0.5);
        }
        .chat-header {
            display: flex;
            align-items: center;
            background: #5350C4;
            padding: 15px 22px;
            justify-content: space-between;
        }
        .chat-header .header-info {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .header-info .chatbot-logo {
            height: 35px;
            width: 35px;
            fill: #5350C4;
            flex-shrink: 0;
            background: #fff;
            border-radius: 50%;
        }
        .header-info .logo-text {
            color: #fff;
            font-size: 1.31rem;
            font-weight: 600;
        }
        #close-chatbot {
            color: #fff;
            height: 40px;
            width: 40px;
            font-size: 1.9rem;
            padding-top: 2px;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
        }
        .chat-body {
            padding: 20px;
            height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .message {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .bot-message {
            flex-direction: row;
        }
        .user-message {
            flex-direction: row-reverse;
        }
        .message-text {
            background: #eee;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.9rem;
            max-width: 70%;
        }
        .user-message .message-text {
            background: #5350C4;
            color: #fff;
        }
        .chat-footer {
            padding: 15px 20px;
            border-top: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .chat-form {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .message-input {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 1rem;
        }
        .chat-controls button {
            border: none;
            background: none;
            color: #5350C4;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .mic-button {
            font-size: 1.5rem;
            color: #5350C4;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="chatbot-popup">
        <div class="chat-header">
            <div class="header-info">
                <svg class="chatbot-logo" xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 1024 1024">
                    <path d="M738.3 287.6H285.7c-59 0-106.8 47.8-106.8 106.8v303.1c0 59 47.8 106.8 106.8 106.8h81.5v111.1c0 .7.8 1.1 1.4.7l166.9-110.6 41.8-.8h117.4l43.6-.4c59 0 106.8-47.8 106.8-106.8V394.5c0-59-47.8-106.9-106.8-106.9zM351.7 448.2c0-29.5 23.9-53.5 53.5-53.5s53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5-53.5-23.9-53.5-53.5zm157.9 267.1c-67.8 0-123.8-47.5-132.3-109h264.6c-8.6 61.5-64.5 109-132.3 109zm110-213.7c-29.5 0-53.5-23.9-53.5-53.5s23.9-53.5 53.5-53.5 53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5zM867.2 644.5V453.1h26.5c19.4 0 35.1 15.7 35.1 35.1v121.1c0 19.4-15.7 35.1-35.1 35.1h-26.5zM95.2 609.4V488.2c0-19.4 15.7-35.1 35.1-35.1h26.5v191.3h-26.5c-19.4 0-35.1-15.7-35.1-35.1zM561.5 149.6c0 23.4-15.6 43.3-36.9 49.7v44.9h-30v-44.9c-21.4-6.5-36.9-26.3-36.9-49.7 0-28.6 23.3-51.9 51.9-51.9s51.9 23.3 51.9 51.9z"></path>
                </svg>
                <h2 class="logo-text">Chatbot</h2>
            </div>
            <button id="close-chatbot" class="material-symbols-rounded">keyboard_arrow_down</button>
        </div>
        <div class="chat-body"></div>
        <div class="chat-footer">
            <form action="#" class="chat-form">
                <textarea placeholder="Message..." class="message-input" required></textarea>
                <div class="chat-controls">
                    <button type="button" id="send-message" class="material-symbols-rounded">arrow_upward</button>
                    <button type="button" id="mic-button" class="mic-button material-symbols-rounded">mic</button>
                </div>
            </form>
        </div>
    </div>
    <script>
        const chatBody = document.querySelector(".chat-body");
        const messageInput = document.querySelector(".message-input");
        const sendMessageButton = document.querySelector("#send-message");
        const micButton = document.querySelector("#mic-button");

        const API_KEY = "AIzaSyC8V-ug0Sx0Au8HIRU6508xRYZLnvLLQBw";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;

        const userData = {
            message: null
        };

        const createMessageElement = (content, ...classes) => {
            const div = document.createElement("div");
            div.classList.add("message", ...classes);
            div.innerHTML = content;
            return div;
        };

        const generateBotResponse = async (incomingMessageDiv) => {
            const messageElement = incomingMessageDiv.querySelector(".message-text");

            const requestOptions = {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: userData.message }] }]
                })
            };
            try {
                const response = await fetch(API_URL, requestOptions);
                const data = await response.json();
                if (!response.ok) throw new Error(data.error.message);

                const apiResponseText = data.candidates[0].content.parts[0].text.replace(/\*\*(.*?)\*\*/g, "<b>$1</b>");
                const botMessageDiv = createMessageElement(
                    `<p class="message-text">${apiResponseText}</p>`,
                    "bot-message"
                );
                chatBody.appendChild(botMessageDiv);
                incomingMessageDiv.remove();
                chatBody.scrollTop = chatBody.scrollHeight;

                // Text-to-speech for bot response
                const utterance = new SpeechSynthesisUtterance(apiResponseText);
                window.speechSynthesis.speak(utterance);

                // Make the bot response clickable to read again
                botMessageDiv.addEventListener("click", () => {
                    window.speechSynthesis.speak(new SpeechSynthesisUtterance(apiResponseText));
                });

            } catch (err) {
                console.error("Error generating response:", err);
                messageElement.textContent = "Oops! Something went wrong.";
            }
        };

        const handleOutgoingMessage = () => {
            const userMessage = messageInput.value.trim();
            if (!userMessage) return;

            userData.message = userMessage;

            const outgoingMessageDiv = createMessageElement(
                `<p class="message-text">${userMessage}</p>`,
                "user-message"
            );
            chatBody.appendChild(outgoingMessageDiv);
            messageInput.value = "";

            const incomingMessageDiv = createMessageElement(
                `<p class="message-text">...</p>`,
                "bot-message"
            );
            chatBody.appendChild(incomingMessageDiv);
            chatBody.scrollTop = chatBody.scrollHeight;

            generateBotResponse(incomingMessageDiv);
        };

        const startRecording = () => {
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'en-US';
            recognition.interimResults = false;

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                messageInput.value = transcript;
            };

            recognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error);
            };

            recognition.start();
        };

        sendMessageButton.addEventListener("click", handleOutgoingMessage);
        messageInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                handleOutgoingMessage();
            }
        });

        micButton.addEventListener("click", startRecording);
    </script>
</body>
</html>
